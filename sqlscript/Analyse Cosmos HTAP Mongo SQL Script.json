{
	"name": "Analyse Cosmos HTAP Mongo SQL Script",
	"properties": {
		"content": {
			"query": "CREATE DATABASE SynapseLinkDB\nGO;\n\nUSE SynapseLinkDB\nGO;\n\n\nSELECT TOP(10) * \nFROM OPENROWSET('CosmosDB',\n                'Account=mycosmosdbsynapselink;Database=CustomerProfile;Key=SlkV9QjUKWfenBKpO0YaagM8E29lxMN9vNfAp0EfRWg61ejXXf9apRNRSxW8E7ux5A2hZBM0GQv7qHHsBSGGow=='\n                ,CustomerProfileHTAP) AS Customer\nWHERE customerid='647';\n\n\nCREATE VIEW Customers\nAS\nSELECT *\n    FROM OPENROWSET('CosmosDB',\n                'Account=mycosmosdbsynapselink;Database=CustomerProfile;Key=SlkV9QjUKWfenBKpO0YaagM8E29lxMN9vNfAp0EfRWg61ejXXf9apRNRSxW8E7ux5A2hZBM0GQv7qHHsBSGGow=='\n                ,CustomerProfileHTAP) \n            WITH \n            (\n                    CustomerId varchar(max) '$.id',\n                    Title varchar(max) '$.title',\n                    FirstName varchar(max) '$.First Name',\n                    LastName varchar(max) '$.Last Name',\n                    EmailAddress varchar(max) '$.email',\n                    PhoneNumber varchar(max) '$.Phone',\n                    AddressLine1 varchar(max) '$.address.addressLine1',\n                    AddressLine2 varchar(max) '$.address.addressLine2',\n                    City varchar(max) '$.address.city',\n                    Country varchar(max) '$.address.country',\n                    ZipCode varchar(max) '$.address.zipCode'\n            )\n                    AS Customers;\n\n\nOR\n\n\nCREATE VIEW Customers\nAS\nSELECT \nCustomerId, CustomerNumId, Title,\nCONCAT(C.\"First Name\", C.FirstName) as FirstName, \nCONCAT(c.LastName,c.\"Last Name\")  as LastName,\nEmailAddress, PhoneNumber, AddressLine1, AddressLine2, City, Country, ZipCode\nFROM \n    (\n    SELECT *\n    FROM OPENROWSET('CosmosDB',\n                'Account=mycosmosdbsynapselink;Database=CustomerProfile;Key=SlkV9QjUKWfenBKpO0YaagM8E29lxMN9vNfAp0EfRWg61ejXXf9apRNRSxW8E7ux5A2hZBM0GQv7qHHsBSGGow=='\n                ,CustomerProfileHTAP) \n    WITH \n            (\n                    CustomerId varchar(max) '$.id',\n                    CustomerNumId varchar(max) '$.customerid',\n                    Title varchar(max) '$.title',\n                    \"First Name\" varchar(max) '$.First Name',\n                    FirstName varchar(max) '$.FirstName',\n                    LastName varchar(max) '$.LastName',\n                    \"Last Name\" varchar(max) '$.Last Name',\n                    EmailAddress varchar(max) '$.email',\n                    PhoneNumber varchar(max) '$.Phone',\n                    AddressLine1 varchar(max) '$.address.addressLine1',\n                    AddressLine2 varchar(max) '$.address.addressLine2',\n                    City varchar(max) '$.address.city',\n                    Country varchar(max) '$.address.country',\n                    ZipCode varchar(max) '$.address.zipCode'\n            )\n    AS Customers\n    -- WHERE customerid='647'\n    ) C;\n\n\n\nSELECT TOP(10) * FROM Customers;\n\n\n\nSELECT top 10 *\n    FROM OPENROWSET('CosmosDB',\n                    'Account=adventureworks-mongodb;Database=AdventureWorks;Key=v2mtZ85W0AMCv1ZrY7j…4g==',\n                    SalesOrder) As SalesOrders;\n\n\n\nCREATE VIEW SalesOrders\nAS\nSELECT  SalesOrderId, SalesOrders.customerId CustomerId, \n        CONVERT(date,orderDate) as OrderDate, CONVERT(date,shipdate) AS ShipDate,\n        Customers.Country, Customers.City\n    FROM OPENROWSET('CosmosDB',\n                    'Account=adventureworks-mongodb;Database=AdventureWorks;Key=v2mtZ85W0AMCv1Zr…D3v4g==',\n                    SalesOrder)\n                        WITH \n                        (\n                            SalesOrderId varchar(max) '$._id.string', \n                            customerId  varchar(max) '$.customerId.string',\n                            orderDate varchar(max) '$.orderDate.string',\n                            shipDate varchar(max) '$.shipDate.string'\n                        )                  \n                        As SalesOrders\n            INNER JOIN Customers\n                On SalesOrders.customerId = Customers.CustomerId;\n\n\n\nSELECT top 10 * FROM SalesOrders;\n\n\nSELECT TOP(10) SalesOrderId, details\n   FROM OPENROWSET('CosmosDB',\n                'Account=adventureworks-mongodb;Database=AdventureWorks;Key=v2mtZ85W0AMCv1ZrY7jMUOWpfBTi1BrUz0Y3Rwmvj9SXSSIKDU7EQVu5kdEMcwAQfvJBnmHSMyxy50c3gD3v4g==',\n                SalesOrder)\n                WITH \n                (   SalesOrderId varchar(max) '$._id', \n                    details varchar(max) '$.details'\n                )  As SalesOrders;\n\n\nSELECT TOP(10) SalesOrderId, details\n   FROM OPENROWSET('CosmosDB',\n                'Account=adventureworks-mongodb;Database=AdventureWorks;Key=v2mtZ85W0AMCv1ZrY7jMUOWpfBTi1BrUz0Y3Rwmvj9SXSSIKDU7EQVu5kdEMcwAQfvJBnmHSMyxy50c3gD3v4g==',\n                SalesOrder)\n                  WITH \n                    (   SalesOrderId varchar(max) '$._id.string', \n                        details varchar(max) '$.details.array'\n                    )  As SalesOrderDetails;\n\n\nCREATE VIEW SalesOrderDetails\nAS\nSELECT SalesOrderId, SalesOrderArray.[key]+1 as SalesOrderLine, SKUCode, SKUName,Price, Quantity\n   FROM OPENROWSET('CosmosDB',\n                'Account=adventureworks-mongodb;Database=AdventureWorks;Key=v2mtZ85W0AMCv1ZrY7jMUOWpfBTi1BrUz0Y3Rwmvj9SXSSIKDU7EQVu5kdEMcwAQfvJBnmHSMyxy50c3gD3v4g==',\n                SalesOrder) \n                    WITH \n                    (   SalesOrderId varchar(max) '$._id.string', \n                        details varchar(max) '$.details.array'\n                    )  As SalesOrders \n        CROSS APPLY OPENJSON(SalesOrders.details) AS SalesOrderArray\n            CROSS APPLY OPENJSON(SalesOrderArray.[value]) \n            WITH\n                (SKUCode varchar(max) '$.object.sku.string',\n                SKUName varchar(max)    '$.object.name.string',\n                Price decimal(10,4) '$.object.price.float64' ,\n                Quantity int    '$.object.quantity.int32'\n            ) As SalesOrderDetails;\n\n\n\nSELECT TOP(10) * FROM SalesOrderDetails;\n\n\nSELECT TOP(10) * FROM \n        SalesOrders\n            INNER JOIN SalesOrderDetails\n                ON SalesOrders.SalesOrderId = SalesOrderDetails.SalesOrderID;\n\n\nCREATE VIEW SalesOrderStats\nAS\nSELECT\n      o.Country, o.City,\n      COUNT(DISTINCT o.CustomerId) Total_Customers,\n      COUNT(DISTINCT d.SalesOrderId) Total_Orders,\n      COUNT(d.SalesOrderId) Total_OrderLines,\n      SUM(d.Quantity*d.Price) AS Total_Revenue,\n      dense_rank() OVER (ORDER BY SUM(d.Quantity*d.Price) DESC) as Rank_Revenue,\n      dense_rank() OVER (ORDER BY COUNT(DISTINCT d.SalesOrderId) DESC) as Rank_Orders,\n      dense_rank() OVER (ORDER BY COUNT(d.SalesOrderId) DESC) as Rank_OrderLines,\n      dense_rank() OVER (PARTITION BY o.Country ORDER BY SUM(d.Quantity*d.Price) DESC) as Rank_Revenue_Country\nFROM SalesOrders o\n INNER JOIN SalesOrderDetails d\n    ON o.SalesOrderId = d.SalesOrderId\nWHERE Country IS NOT NULL OR City IS NOT NULL\nGROUP BY o.Country, o.City\nGO\n\nSELECT * FROM SalesOrderStats\nGO\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Built-in",
				"databaseName": "SynapseLinkDB"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}